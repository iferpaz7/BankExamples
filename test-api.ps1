# ?? Credit Card API - Testing Script
# PowerShell script para probar todos los endpoints

$baseUrl = "http://localhost:5282"
$cardId = $null

Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?     Credit Card API - Automated Testing Script              ?" -ForegroundColor Cyan
Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""

# Función para hacer peticiones HTTP
function Invoke-ApiRequest {
    param(
        [string]$Method,
        [string]$Endpoint,
        [object]$Body = $null,
        [string]$Description
    )
    
    Write-Host "? Testing: $Description" -ForegroundColor Yellow
    Write-Host "  Method: $Method $Endpoint" -ForegroundColor Gray
    
    try {
        $headers = @{
            "Content-Type" = "application/json"
            "Accept" = "application/json"
        }
        
        $params = @{
            Uri = "$baseUrl$Endpoint"
            Method = $Method
            Headers = $headers
        }
        
        if ($Body) {
            $params.Body = ($Body | ConvertTo-Json -Depth 10)
        }
        
        $response = Invoke-RestMethod @params
        Write-Host "  ? Success!" -ForegroundColor Green
        Write-Host "  Response: $($response | ConvertTo-Json -Compress)" -ForegroundColor DarkGray
        Write-Host ""
        return $response
    }
    catch {
        Write-Host "  ? Error: $($_.Exception.Message)" -ForegroundColor Red
        Write-Host ""
        return $null
    }
}

# Test 1: Crear tarjeta Visa
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "TEST 1: CREATE OPERATIONS" -ForegroundColor Cyan
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan

$visaCard = @{
    cardNumber = "4532015112830366"
    cardHolderName = "Juan Pérez"
    expirationDate = "12/2027"
    cvv = "123"
    creditLimit = 10000.00
    cardType = "Visa"
}

$result = Invoke-ApiRequest -Method "POST" -Endpoint "/api/creditcards" -Body $visaCard -Description "Crear tarjeta Visa"
if ($result) {
    $cardId = $result.id
    Write-Host "? Card ID guardado: $cardId" -ForegroundColor Green
}

# Test 2: Crear tarjeta MasterCard
$masterCard = @{
    cardNumber = "5425233430109903"
    cardHolderName = "María García"
    expirationDate = "06/2026"
    cvv = "456"
    creditLimit = 15000.00
    cardType = "MasterCard"
}

Invoke-ApiRequest -Method "POST" -Endpoint "/api/creditcards" -Body $masterCard -Description "Crear tarjeta MasterCard"

# Test 3: Crear tarjeta American Express
$amexCard = @{
    cardNumber = "374245455400126"
    cardHolderName = "Carlos Rodríguez"
    expirationDate = "09/2028"
    cvv = "7890"
    creditLimit = 25000.00
    cardType = "American Express"
}

Invoke-ApiRequest -Method "POST" -Endpoint "/api/creditcards" -Body $amexCard -Description "Crear tarjeta American Express"

Start-Sleep -Seconds 1

# Test 4: Obtener todas las tarjetas
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "TEST 2: READ OPERATIONS" -ForegroundColor Cyan
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan

Invoke-ApiRequest -Method "GET" -Endpoint "/api/creditcards" -Description "Obtener todas las tarjetas"

# Test 5: Obtener tarjeta por ID
if ($cardId) {
    Invoke-ApiRequest -Method "GET" -Endpoint "/api/creditcards/$cardId" -Description "Obtener tarjeta por ID"
}

Start-Sleep -Seconds 1

# Test 6: Actualizar tarjeta
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "TEST 3: UPDATE OPERATIONS" -ForegroundColor Cyan
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan

if ($cardId) {
    $updateData = @{
        cardHolderName = "Juan Carlos Pérez Martínez"
        creditLimit = 12000.00
    }
    
    Invoke-ApiRequest -Method "PUT" -Endpoint "/api/creditcards/$cardId" -Body $updateData -Description "Actualizar información de tarjeta"
}

Start-Sleep -Seconds 1

# Test 7: Operaciones de negocio
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "TEST 4: BUSINESS OPERATIONS" -ForegroundColor Cyan
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan

if ($cardId) {
    # Realizar cargo
    $chargeData = @{
        amount = 2500.00
    }
    Invoke-ApiRequest -Method "POST" -Endpoint "/api/creditcards/$cardId/charge" -Body $chargeData -Description "Realizar cargo de $2500"
    
    Start-Sleep -Seconds 1
    
    # Realizar otro cargo
    $chargeData2 = @{
        amount = 3000.00
    }
    Invoke-ApiRequest -Method "POST" -Endpoint "/api/creditcards/$cardId/charge" -Body $chargeData2 -Description "Realizar cargo de $3000"
    
    Start-Sleep -Seconds 1
    
    # Ver estado después de cargos
    Invoke-ApiRequest -Method "GET" -Endpoint "/api/creditcards/$cardId" -Description "Ver estado después de cargos"
    
    Start-Sleep -Seconds 1
    
    # Realizar pago
    $paymentData = @{
        amount = 1500.00
    }
    Invoke-ApiRequest -Method "POST" -Endpoint "/api/creditcards/$cardId/payment" -Body $paymentData -Description "Realizar pago de $1500"
    
    Start-Sleep -Seconds 1
    
    # Ver estado final
    Invoke-ApiRequest -Method "GET" -Endpoint "/api/creditcards/$cardId" -Description "Ver estado después del pago"
}

Start-Sleep -Seconds 1

# Test 8: Reportes
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "TEST 5: REPORTS (DAPPER)" -ForegroundColor Cyan
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan

Invoke-ApiRequest -Method "GET" -Endpoint "/api/reports/creditcards" -Description "Reporte completo de tarjetas"

Start-Sleep -Seconds 1

if ($cardId) {
    Invoke-ApiRequest -Method "GET" -Endpoint "/api/reports/creditcards/$cardId" -Description "Reporte de tarjeta específica"
}

Start-Sleep -Seconds 1

Invoke-ApiRequest -Method "GET" -Endpoint "/api/reports/creditcards/active" -Description "Reporte de tarjetas activas"

Start-Sleep -Seconds 1

Invoke-ApiRequest -Method "GET" -Endpoint "/api/reports/creditcards/high-usage?minPercentage=30" -Description "Tarjetas con uso alto (>30%)"

Start-Sleep -Seconds 1

# Test 9: Activar/Desactivar
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "TEST 6: ACTIVATE/DEACTIVATE" -ForegroundColor Cyan
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan

if ($cardId) {
    Invoke-ApiRequest -Method "POST" -Endpoint "/api/creditcards/$cardId/deactivate" -Description "Desactivar tarjeta"
    
    Start-Sleep -Seconds 1
    
    Invoke-ApiRequest -Method "GET" -Endpoint "/api/creditcards/$cardId" -Description "Ver estado (desactivada)"
    
    Start-Sleep -Seconds 1
    
    Invoke-ApiRequest -Method "POST" -Endpoint "/api/creditcards/$cardId/activate" -Description "Reactivar tarjeta"
    
    Start-Sleep -Seconds 1
    
    Invoke-ApiRequest -Method "GET" -Endpoint "/api/creditcards/$cardId" -Description "Ver estado (activada)"
}

Start-Sleep -Seconds 1

# Test 10: Casos de error
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "TEST 7: ERROR CASES (Expected Failures)" -ForegroundColor Cyan
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan

# Error: Tarjeta duplicada
$duplicateCard = @{
    cardNumber = "4532015112830366"
    cardHolderName = "Duplicate Test"
    expirationDate = "12/2027"
    cvv = "123"
    creditLimit = 10000.00
    cardType = "Visa"
}
Invoke-ApiRequest -Method "POST" -Endpoint "/api/creditcards" -Body $duplicateCard -Description "ERROR TEST: Número de tarjeta duplicado"

Start-Sleep -Seconds 1

# Error: CVV inválido
$invalidCvv = @{
    cardNumber = "4916338506082833"
    cardHolderName = "Invalid CVV"
    expirationDate = "12/2027"
    cvv = "12"
    creditLimit = 10000.00
    cardType = "Visa"
}
Invoke-ApiRequest -Method "POST" -Endpoint "/api/creditcards" -Body $invalidCvv -Description "ERROR TEST: CVV inválido (2 dígitos)"

Start-Sleep -Seconds 1

# Error: Número de tarjeta inválido
$invalidCard = @{
    cardNumber = "123456789"
    cardHolderName = "Invalid Card"
    expirationDate = "12/2027"
    cvv = "123"
    creditLimit = 10000.00
    cardType = "Visa"
}
Invoke-ApiRequest -Method "POST" -Endpoint "/api/creditcards" -Body $invalidCard -Description "ERROR TEST: Número de tarjeta inválido"

Start-Sleep -Seconds 1

if ($cardId) {
    # Error: Cargo excesivo
    $excessiveCharge = @{
        amount = 999999.00
    }
    Invoke-ApiRequest -Method "POST" -Endpoint "/api/creditcards/$cardId/charge" -Body $excessiveCharge -Description "ERROR TEST: Cargo que excede crédito disponible"
}

# Resumen final
Write-Host ""
Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host "?              Tests Completados                               ?" -ForegroundColor Green
Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host ""
Write-Host "Para ver la documentación completa de Swagger:" -ForegroundColor Cyan
Write-Host "  $baseUrl/swagger" -ForegroundColor White
Write-Host ""
